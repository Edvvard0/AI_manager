<!DOCTYPE html>
<html lang="ru">
<head>
    {% include 'base.html' %}
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .chat-container {
            flex: 1;
            padding: 60px 20px 60px 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .user-message {
            background-color: #ffffff;
            align-self: flex-end;
        }

        .bot-message {
            background-color: #ffffff;
            align-self: flex-start;
        }

        .input-wrapper {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #ffffff;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            padding: 10px 20px;
        }

        .file-preview-container {
            margin-bottom: 8px;
        }

        .file-preview {
            display: inline-flex;
            align-items: center;
            justify-content: space-between;
            font-size: 12px;
            color: #333;
            background-color: #f1f1f1;
            padding: 4px 8px;
            border-radius: 6px;
            margin-right: 6px;
            max-width: 250px;
        }

        .file-remove {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
            color: #666;
        }

        .file-remove:hover {
            color: #000;
        }

        .input-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #message-input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .round-button {
            width: 40px;
            height: 40px;
            background-color: #ffffff;
            color: #000000;
            border: 1px solid #d3d3d3;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .round-button:hover {
            background-color: #e9ecef;
        }

        #file-input {
            display: none;
        }

        .loading {
            font-size: 18px;
            text-align: center;
            margin-top: 20px;
            color: #555;
            display: none; /* скрыта по умолчанию */
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body>
{% block content %}
    <div class="chat-container" id="chat-container">
        <div class="loading" id="task-loading">Формирование задач…</div>
        {% for msg in messages %}
            <div class="message {% if msg.is_user %}user-message{% else %}bot-message{% endif %}">
                {% if msg.file_name %}
                    <div class="file-preview">{{ msg.file_name }}</div>
                {% endif %}
                <div class="message-content">{{ msg.content | safe }}</div>
            </div>
        {% endfor %}
    </div>

    <div class="input-wrapper">
        <div class="file-preview-container" id="file-preview-container"></div>
        <div class="input-container">
            <input type="file" id="file-input" accept=".pdf,.txt,.docx,.md,.csv">
            <button id="file-button" class="round-button">+</button>
            <input type="text" id="message-input" placeholder="Введите сообщение...">
            <button id="send-button" class="round-button">↑</button>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    const chatId = {{ chat_id }};
    const fileInput = document.getElementById("file-input");
    const fileButton = document.getElementById("file-button");
    const filePreviewContainer = document.getElementById("file-preview-container");
    const taskLoading = document.getElementById("task-loading");
    let selectedFile = null;

    fileButton.addEventListener("click", () => fileInput.click());

    fileInput.addEventListener("change", () => {
        if (fileInput.files.length > 0) {
            const file = fileInput.files[0];
            const allowedTypes = [
                "application/pdf",
                "text/plain",
                "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                "text/markdown",
                "text/csv",
                "application/vnd.ms-excel"
            ];
            if (!allowedTypes.includes(file.type) && !file.name.endsWith(".md")) {
                alert("Этот тип файла не поддерживается. Разрешены: PDF, TXT, DOCX, MD, CSV");
                fileInput.value = "";
                selectedFile = null;
                return;
            }
            selectedFile = file;
            renderFilePreview(file.name);
        }
    });

    const renderFilePreview = (fileName) => {
        filePreviewContainer.innerHTML = "";
        const preview = document.createElement("div");
        preview.className = "file-preview";
        preview.innerHTML = `
            <span>${fileName}</span>
            <span class="file-remove">×</span>
        `;
        preview.querySelector(".file-remove").addEventListener("click", () => {
            selectedFile = null;
            fileInput.value = "";
            preview.remove();
        });
        filePreviewContainer.appendChild(preview);
    };

    document.getElementById("send-button").addEventListener("click", async () => {
        const input = document.getElementById("message-input");
        const message = input.value.trim();

        if (!message && !selectedFile) return;
        input.value = "";

        if (message.toUpperCase().startsWith("РАСПРЕДЕЛИ ЗАДАЧИ")) {
            taskLoading.style.display = "block"; // показываем надпись
            const url = `/pages/add_tasks/${chatId}?content=${encodeURIComponent(message)}`;
            window.location.href = url;
            return;
        }

        taskLoading.style.display = "none"; // скрываем надпись для всех остальных сообщений
        addMessage(message || "[Файл отправлен]", true, selectedFile?.name);
        const typingDiv = addTypingIndicator();

        try {
            let response;
            if (selectedFile) {
                const formData = new FormData();
                formData.append("prompt", message || "");
                formData.append("file", selectedFile);

                response = await fetch(`/chat_gpt/messages/?chat_id=${chatId}`, {
                    method: "POST",
                    body: formData
                });
            } else {
                response = await fetch(`/chat_gpt/messages/`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ chat_id: chatId, content: message })
                });
            }

            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            removeTypingIndicator(typingDiv);
            addMessage(data.message || data.answer, false);

            fileInput.value = "";
            selectedFile = null;
            filePreviewContainer.innerHTML = "";
        } catch (error) {
            removeTypingIndicator(typingDiv);
            addMessage("Ошибка: " + error.message, false);
            console.error("Fetch error:", error);
        }
    });

    const addMessage = (text, isUser, fileName=null) => {
        if (!text && !fileName) return;
        const chatContainer = document.getElementById("chat-container");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("message");
        messageDiv.classList.add(isUser ? "user-message" : "bot-message");

        if (fileName) {
            const fileDiv = document.createElement("div");
            fileDiv.classList.add("file-preview");
            fileDiv.textContent = fileName;
            messageDiv.appendChild(fileDiv);
        }

        if (text) {
            const contentDiv = document.createElement("div");
            contentDiv.classList.add("message-content");
            contentDiv.innerHTML = marked.parse(text);
            messageDiv.appendChild(contentDiv);
        }

        chatContainer.appendChild(messageDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    };

    const addTypingIndicator = () => {
        const chatContainer = document.getElementById("chat-container");
        const typingDiv = document.createElement("div");
        typingDiv.classList.add("typing-indicator");
        typingDiv.textContent = "Печатает...";
        chatContainer.appendChild(typingDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return typingDiv;
    };

    const removeTypingIndicator = (typingDiv) => typingDiv.remove();

    document.getElementById("message-input").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            document.getElementById("send-button").click();
        }
    });
</script>
{% endblock %}
</body>
</html>
